<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>List</title>
    <link rel="stylesheet" href="../style/list_alunos1.css" />
    <link rel="stylesheet" href="../style/list_alunos2.css" />
  </head>

  <body>
    <div id="titlediv">
      <div id="titlemain">Gym Control System</div>
      <div id="gym-name">Kussano gym</div>
    </div>

    <div id="dash">
      <div id="header">
        <h3>Tabela de alunos</h3>
        <select name="" id="filter1">
          <option value="">Categoria</option>
          <option value="All">Todos</option>
          <option value="Man">Homem</option>
          <option value="Women">Mulher</option>
          <option value="teenagers">Menores</option>
        </select>
        <select name="" id="filter2">
          <option value="">Planos</option>
          <option value="Plan A">Plano A</option>
          <option value="Plan B">Plano B</option>
          <option value="Plan C">Plano C</option>
          <option value="Plan D">Plano D</option>
          <option value="Plan E">Plano E</option>
          <option value="Plan F">Plano F</option>
          <option value="Plan G">Plano G</option>
          <option value="Plan H">Plano H</option>
          <option value="Plan I">Plano I</option>
          <option value="Plan J">Plano J</option>
          <option value="Plan K">Plano K</option>
          <option value="Plan L">Plano L</option>
          <option value="Plan M">Plano M</option>
          <option value="Plan N">Plano N</option>
          <option value="Plan free">Plano free</option>
        </select>
        <input type="button" id="btn-filter" value="Buscar" />
      </div>
      <div  class="twrapper">
       <table>
         <tbody></tbody>
       </table>
     </div>
    </div>
  </body>
  <script src="../script/swal.min.js"></script>
  <script>
 const tbody = document.getElementsByTagName("tbody")[0];
    const btnFilter = document.getElementById("btn-filter");
    const gymName = document.getElementById("gym-name");
    const sessionGymName = sessionStorage.getItem("gym");
    let maylanguage = "PT"

    if (sessionGymName) {
      gymName.innerHTML = sessionGymName;
    } else {
      gymName.innerHTML = "GYM error";
    }

    //função para executar filtros--------------------------->
    btnFilter.addEventListener("click", function () {
      const filter1 = document.getElementById("filter1").value;
      const filter2 = document.getElementById("filter2").value;
      const obj = { opt1: filter1, opt2: filter2 };

      fetch("https://squid-app-ug7x6.ondigitalocean.app/list", {
        method: "POST",
        body: JSON.stringify(obj),
        headers: { "Content-type": "application/json; charset=UTF-8" },
      })
        .then((x) => x.json())
        .then((res) => {
          var removeTbody = document.querySelector("tbody");
          while (removeTbody.hasChildNodes()) {
            removeTbody.removeChild(removeTbody.firstChild);
          }
          clients = res;
          clientsHandler();
        });
    });

    //função para pegar todos os registros quando o user entrar na página---->
    let clients;

    fetch("https://squid-app-ug7x6.ondigitalocean.app/list", {
      method: "POST",
      body: JSON.stringify({ opt1: "", opt2: "" }),
      headers: { "Content-type": "application/json; charset=UTF-8" },
    })
      .then((x) => x.json())
      .then((res) => {
        clients = res;
        clientsHandler();
      });

    function clientsHandler() {
      for (let index = 0; index < clients.length; index++) {
        if(index==0){
                  const row1 = createNewTableRow_first(clients[index]);
                      tbody.innerHTML += row1;
                    const  row = createNewTableRow(clients[index]);
                          tbody.innerHTML += row;
                }else{
                  const row = createNewTableRow(clients[index]);
                      tbody.innerHTML += row;
                }
      //  const row = createNewTableRow(clients[index]);
      //  tbody.innerHTML += row;
      }
    }

    function createNewTableRow(data) {
      let genero
      let language
      let status
      if(data.genero=="man"){
         if(maylanguage=="PT"){
           genero = "Homem"
         }else if (maylanguage=="EN"){
           genero = data.genero
         }else{
            genero =　"男性"
         }
      }else{
        if(maylanguage=="PT"){
          genero = "Mulher"
        }else if (maylanguage=="EN"){
          genero = data.genero
        }else{
           genero =　"女性"
        }
      }

      if(data.status=="active"){
         if(maylanguage=="PT"){
           status = "Ativo"
         }else if (maylanguage=="EN"){
           status = "Active"
         }else{
            status = "在籍"
         }
      }else{
        if(maylanguage=="PT"){
          status = "Inativo"
        }else if (maylanguage=="EN"){
          status = "Inactive"
        }else{
           status = "退会"
        }
      }

      if(maylanguage=="PT"){
         if(data.lang01=="Portugues"){
           language = "Português"
         }else if (data.lang01=="Inglês"){
            language = "Inglês"
         }else{
             language = "Japonês"
         }
      }else if(maylanguage=="EN"){
        if(data.lang01=="Portugues"){
          language = "Portuguese"
        }else if (data.lang01=="Inglês"){
           language = "English"
        }else{
            language = "Japanese"
        }
      }else{
        if(data.lang01=="Portugues"){
          language = "ポルトガル語"
        }else if (data.lang01=="Inglês"){
           language = "英語"
        }else{
            language = "日本語"
        }
      }
      let row = `
      <tr>
        <th class="_sticky" name="_sticky_name">${data.nm_member}</th>
       <td>${data.birthday_year}/${data.birthday_month}/${data.birthday_day}</td>
        <td>${data.birthday_age}</td>
        <td>${genero}</td>
        <td class="email-tag">${data.adress_input}</td>
        <td class="email-tag">0${data.phone01}-${data.phone02}-${data.phone03}</td>
        <td class="email-tag">${data.email}</td>
        <td>${language}</td>
        <td>${data.plans}</td>
        <td>${status}</td>
        <td>${data.pass}</td>
        <td>
            <img src="../image/edit.svg" onClick="editClient(${data.id})" alt="" width="25">
            <img src="../image/delete.svg" onClick="deleteClient(${data.id})" alt="" width="25">
        </td>
        </tr>
        `;
      return row;
    }

    function createNewTableRow_first(data) {
     let row = `
       <tr>
       <th class="_sticky z-02">Aluno</th>
       <th class="_sticky">Data de nascimento</th>
       <th class="_sticky">Idade</th>
       <th class="_sticky">Gênero</th>
       <th class="_sticky">Endereço</th>
       <th class="_sticky">Tel</th>
       <th class="_sticky">Email</th>
       <th class="_sticky">Idioma</th>
       <th class="_sticky">Plano</th>
       <th class="_sticky">Situação</th>
       <th class="_sticky">Pass</th>
       <th class="_sticky">Ações</th>
       </tr>
       `;

     return row;
    }





    function editClient(clientId) {
      let client = clients.find((client) => client.id == clientId);
      Swal.fire({
        html: `
                <div id="title">Faça a alteração no campo desejado</div>
                <div id="client">
                    <div class="div-block">
                        <div class="div-span">
                        <span>Nome: </span>
                        </div>
                        <div class="input-select">
                        <input type="text" id="clientName" value="${client.nm_member}"/>
                        </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span-r">
                        <span>Aniversário: </span>
                        </div>
                        <div  id="birth-input" class="input-select">
                        <input type="text" id="clientBirth" value="${client.birthday_year}-${client.birthday_month}-${client.birthday_day}"/>
                     </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span">
                        <span>Idade: </span>
                        </div>
                        <div class="input-select">
                        <input type="number" maxlength="2" id="clientAge" value="${client.birthday_age}"/>
                    </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span-r">
                        <span>Gênero: </span>
                        </div>
                        <div  id="genero-input" class="input-select">
                        <select type="text" id="clientGender">
                        <option value="Male">Male</option>/>
                        <option value="Female">Female</option>/>
                        <option value="${client.genero}" selected>${client.genero}</option>
                        </select>
                        </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span">
                        <span>Endereço: </span>
                        </div>
                        <div class="input-select">
                        <input type="text" id="clientAddress" value="${client.adress_input}"/>
                    </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span-r">
                        <span>Telefone: </span>
                        </div>
                        <div  id="phone-input" class="input-select">
                        <input type="text" id="clientTel" value="0${client.phone01}-${client.phone02}-${client.phone03}"/>
                    </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span">
                        <span>E-mail: </span>
                        </div>
                        <div class="input-select">
                        <input type="text" id="clientEmail" value="${client.email}"/>
                    </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span-r">
                        <span>Idioma: </span>
                        </div>
                        <div  id="language-input" class="input-select">
                        <select type="text" id="clientlanguage">
                        <option value="japanese">japanese</option>/>
                        <option value="portugues">portugues</option>/>
                        <option value="english">english</option>/>
                        <option value="${client.lang01}" selected>${client.lang01}</option>
                        </select>
                        </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span">
                        <span>Plano: </span>
                        </div>
                        <div class="input-select">
                        <select type="text" id="clientplan">
                        <option value="Plan A">Plan A</option>/>
                        <option value="Plan B">Plan B</option>/>
                        <option value="Plan C">Plan C</option>/>
                        <option value="Plan D">Plan D</option>/>
                        <option value="Plan E">Plan E</option>/>
                        <option value="Plan F">Plan F</option>/>
                        <option value="Plan G">Plan G</option>/>
                        <option value="Plan H">Plan H</option>/>
                        <option value="Plan I">Plan I</option>/>
                        <option value="Plan J">Plan J</option>/>
                        <option value="Plan K">Plan K</option>/>
                        <option value="Plan L">Plan L</option>/>
                        <option value="Plan M">Plan M</option>/>
                        <option value="Plan N">Plan N</option>/>
                        <option value="Plan free">Plan Free</option>/>
                        <option value="${client.plans}" selected>${client.plans}</option>
                        </select>
                        </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span-r">
                        <span>Pass: </span>
                        </div>
                        <div id="pass-input" class="input-select">
                        <input maxlength="4"  id="clientPass" value="${client.pass}"/>
                     </div>
                    </div>
                    <div class="div-block">
                        <div class="div-span">
                        <span>Status: </span>
                        </div>
                        <div class="input-select">
                        <select type="text" id="clientStatus">
                        <option value="active">active</option>/>
                        <option value="inactive">inactive</option>/>
                        <option value="${client.status}" selected>${client.status}</option>
                        </select>
                    </div>
                    </div>

                </div>

                <style>
                #title{
                  font-size:4vh;

                }
                    #client{
                        width: 100%;
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: flex-start;
                        background-color: #EEEEEE;
                        padding-top: 3%;
                    }

                    #client div{
                        width: 50%;
                        display: flex;
                        align-items: center;
                        padding-bottom: 2%;
                    }

                    #client div input{
                        border-radius: 10px;
                        height: 5vh;
                        border: 1px solid gray;
                        text-indent: 10px;
                        width: 50vh;
                    }
                    #client div select{
                      border-radius: 10px;
                      width: 50vh;
                      height: 5vh;
                      border: 1px solid gray;
                      text-indent: 10px
                      width: 50vh;
                    }
                    #clientBirth{
                      border-radius: 10px;
                      width: 50vh;
                      height: 5vh;
                      border: 1px solid gray;
                      text-indent: 10px
                    }
                   .div-span{
                     display:flex;
                     justify-content: flex-end;
                   }
                   .div-span-r{
                     display:flex;
                     justify-content: flex-end;
                     width:10%;

                   }

                   #pass-input{
                     margin-right:100px;
                   }
                   #phone-input{
                     margin-right:100px;
                   }
                   #graduacao-input{
                     margin-right:100px;
                   }
                   #language-input{
                     margin-right:100px;
                   }
                   #genero-input{
                     margin-right:100px;
                   }
                   #birth-input{
                     margin-right:100px;
                   }

                  @media only screen and (max-width: 700px) {
                     #title{
                       font-size:1em;
                     }
                     #client{
                       display:block;
                     }
                     .div-block{
                        display:block;
                        width:100%;
                        height:100px;
                     }
                     #client div{
                         width: 100%;
                         display: block;
                         padding-bottom: 1%;
                         justify-content: start;
                         padding-left: 1%;
                       }
                       #client div input{
                           width: 25vh;
                       }
                       #client div select{
                           width: 25vh;
                       }
                  }
                </style>

            `,
        showCancelButton: true,
        confirmButtonText: "Salvar",
        cancelButtonText: "Cancelar",
        width: 700,
      }).then((result) => {
       if (result.isConfirmed) {
         try{
          let obj = {
            id: clientId,
            nm_member: document.getElementById("clientName").value,
            birth1: document.getElementById("clientBirth").value.split("-")[0],
            birth2: document.getElementById("clientBirth").value.split("-")[1],
            birth3: document.getElementById("clientBirth").value.split("-")[2],
            age: document.getElementById("clientAge").value,
            gender: document.getElementById("clientGender").value,
            address: document.getElementById("clientAddress").value,
            tel1: document.getElementById("clientTel").value.split("-")[0],
            tel2: document.getElementById("clientTel").value.split("-")[1],
            tel3: document.getElementById("clientTel").value.split("-")[2],
            email: document.getElementById("clientEmail").value,
            language: document.getElementById("clientlanguage").value,
            plan: document.getElementById("clientplan").value,
            status: document.getElementById("clientStatus").value,
            pass: document.getElementById("clientPass").value,
          };

if(obj.nm_member==""){
  swall_error(2,clientId)
}else if(obj.birth==""){
  swall_error(3,clientId)
}else if(obj.age==""){
  swall_error(4,clientId)
}else if(obj.address==""){
  swall_error(5,clientId)
}else if(document.getElementById("clientTel").value==""){
  swall_error(6,clientId)
}else if(obj.email==""){
swall_error(7,clientId)
}else if(obj.pass==""){
  swall_error(8,clientId)
}else{
          console.log(obj);
          const attr = {
            method: "POST",
            body: JSON.stringify(obj),
            headers: { "Content-type": "application/json; charset=UTF-8" },
          };
          fetch("https://squid-app-ug7x6.ondigitalocean.app/listUpdate", attr)
            //.then((x) => x.json())
          //  .then((response) => {
          .then(response =>	{
            if(!response.ok){
              console.log(response)
              swall_error(1)
            }else{
              restartTable();
              swall_success()
            }
            });
          }
        }catch (error) {
          console.log(error)
           swall_error(1)

        }
        }
      });

      //mascara para o campo de telefone
      let campoTel = document.getElementById("clientTel");
      campoTel.addEventListener("blur", () => {
        var value = campoTel.value;
        var a = value.replace(/\D/g, ""); //Remove tudo o que não é dígito
        var b = a.replace(/^(\d{2})(\d)/g, "($1$2)"); //Coloca parênteses em volta dos dois primeiros dígitos
        var c = b.replace(/(\d)(\d{4})$/, "$1-$2"); //Coloca hífen entre o quarto e o quinto dígitos
        campoTel.value = c;
      });
    }

    function deleteClient(clientId) {
      clients = clients.filter((client) => client.id != clientId);
      const attr = {
        method: "POST",
        body: JSON.stringify({ id: clientId }),
        headers: { "Content-type": "application/json; charset=UTF-8" },
      };
      fetch("https://squid-app-ug7x6.ondigitalocean.app/listDelete", attr)
        .then((x) => x.json())
        .then((response) => {
          console.log(response);
        });
      restartTable();
    }

   async function restartTable() {

      var removeTbody = document.querySelector("tbody");
      while (removeTbody.hasChildNodes()) {
        removeTbody.removeChild(removeTbody.firstChild);
      }

     setTimeout(() => {
        fetch("https://squid-app-ug7x6.ondigitalocean.app/list", {
          method: "POST",
          body: JSON.stringify({ opt1: "", opt2: "" }),
          headers: { "Content-type": "application/json; charset=UTF-8" },
        })
          .then((x) => x.json())
          .then((res) => {
            clients = res;
            clientsHandler();
          });
      }, 3000);
    };

 function swall_error(data,clientId){
if(maylanguage=="PT"){
  errortitle = "Erro"
  if(data==1){
    errormessage = "Erro no registro, tente novamente"
  }else if(data==2){
    errormessage = "O campo do nome não pode está em branco"
  }else if(data==3){
    errormessage = "O campo da data de nascimento não pode está em branco"
  }else if(data==4){
    errormessage = "O campo da idade não pode está em branco"
  }else if(data==5){
    errormessage = "O campo do endereço não pode está em branco"
  }else if(data==6){
    errormessage = "O campo do telefone não pode está em branco"
  }else if(data==7){
    errormessage = "O campo do email não pode está em branco"
  }else if(data==8){
    errormessage = "O campo da senha não pode está em branco"
  }
}else if(maylanguage=="EN"){
  errortitle = "Error"
  if(data==1){
    errormessage = "Try again"
  }else if(data==2){
    errormessage = "Please enter full name"
  }else if(data==3){
    errormessage = "Please enter date of birth"
  }else if(data==4){
    errormessage = "Please enter age"
  }else if(data==5){
    errormessage = "Please enter adress"
  }else if(data==6){
    errormessage = "Please enter phone"
  }else if(data==7){
    errormessage = "Please enter email"
  }else if(data==8){
    errormessage = "Please enter password"
  }
}else{
    errortitle = "エラー"
    if(data==1){
      errormessage = "登録に失敗しました、再度試してください"
    }else if(data==2){
      errormessage = "名前を入力してください"
    }else if(data==3){
      errormessage = "生年月日を入力してください"
    }else if(data==4){
      errormessage = "年齢を入力してください"
    }else if(data==5){
      errormessage = "住所を入力してください"
    }else if(data==6){
      errormessage = "電話番号を入力してください"
    }else if(data==7){
      errormessage = "メールアドレスを入力してください"
    }else if(data==8){
      errormessage = "パスワードを入力してください"
    }
}
  Swal.fire({
  title: errortitle
, html : errormessage
, icon : 'error'
}).then((result) => {
 if (result.isConfirmed) {
    editClient(clientId)
 }
})
    }

    function swall_success(){
        if(maylanguage=="PT"){
          errormessage = "Alteração foi feita com sucesso"
          errortitle = "Pronto"
        }else if(maylanguage=="EN"){
         errormessage = "Change was successfully made"
         errortitle = "Success"
       }else{
         errormessage = "変更が完了しました"
         errortitle = "完了"
       }
     Swal.fire({
     title: errortitle
   , html : errormessage
   , icon : 'success'
   , timer : '1500'
   });
       }
  </script>
</html>
