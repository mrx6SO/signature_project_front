<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>List</title>
    <link rel="stylesheet" href="../style/list_alunos1.css" />
    <link rel="stylesheet" href="../style/list_alunos2.css" />
  </head>

  <body>
    <div id="titlediv">
      <div id="titlemain">Gym Control System</div>
      <div id="gym-name">Kussano gym</div>
    </div>

    <div id="dash">
      <div id="header">
        <h3>Tabela de alunos</h3>
        <select name="" id="filter1">
          <option value="">Filter</option>
          <option value="All">All</option>
          <option value="Man">Man</option>
          <option value="Women">Women</option>
          <option value="teenagers">teenagers</option>
        </select>
        <select name="" id="filter2">
          <option value="">categoria1</option>
          <option value="Plan A">Plan A</option>
          <option value="Plan B">Plan B</option>
          <option value="Plan C">Plan C</option>
          <option value="Plan D">Plan D</option>
          <option value="Plan E">Plan E</option>
          <option value="Plan F">Plan F</option>
        </select>
        <input type="button" id="btn-filter" value="Buscar" />
      </div>
      <div id="table">
        <table cellspacing="0" cellpadding="0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Birth</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Address</th>
              <th>Tel</th>
              <th>Email</th>
              <th>Language</th>
              <th>Plan</th>
              <th>Graduation</th>
              <th>Status</th>
              <th>Pass</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </body>
  <script src="../script/swal.min.js"></script>
  <script>
 const tbody = document.getElementsByTagName("tbody")[0];
    const btnFilter = document.getElementById("btn-filter");
    const gymName = document.getElementById("gym-name");
    const sessionGymName = sessionStorage.getItem("gym");

    if (sessionGymName) {
      gymName.innerHTML = sessionGymName;
    } else {
      gymName.innerHTML = "GYM error";
    }

    //função para executar filtros--------------------------->
    btnFilter.addEventListener("click", function () {
      const filter1 = document.getElementById("filter1").value;
      const filter2 = document.getElementById("filter2").value;
      const obj = { opt1: filter1, opt2: filter2 };

      fetch("https://squid-app-ug7x6.ondigitalocean.app/list", {
        method: "POST",
        body: JSON.stringify(obj),
        headers: { "Content-type": "application/json; charset=UTF-8" },
      })
        .then((x) => x.json())
        .then((res) => {
          var removeTbody = document.querySelector("tbody");
          while (removeTbody.hasChildNodes()) {
            removeTbody.removeChild(removeTbody.firstChild);
          }
          clients = res;
          clientsHandler();
        });
    });
    
    //função para pegar todos os registros quando o user entrar na página---->
    let clients;

    fetch("https://squid-app-ug7x6.ondigitalocean.app/list", {
      method: "POST",
      body: JSON.stringify({ opt1: "", opt2: "" }),
      headers: { "Content-type": "application/json; charset=UTF-8" },
    })
      .then((x) => x.json())
      .then((res) => {
        clients = res;
        clientsHandler();
      });

    function clientsHandler() {
      for (let index = 0; index < clients.length; index++) {
        const row = createNewTableRow(clients[index]);
        tbody.innerHTML += row;
      }
    }

    function createNewTableRow(data) {
      let row = `
        <td>${data.nm_member}</td>
        <td>${data.birthday_day}/${data.birthday_month}/${data.birthday_year}</td>
        <td>${data.birthday_age}</td>
        <td>${data.genero}</td>
        <td>${data.adress_input}</td>
        <td>(${data.phone01}) ${data.phone02}-${data.phone03}</td>
        <td>${data.email}</td>
        <td>${data.lang01}</td>
        <td>${data.plans}</td>
        <td>${data.graduation}</td>
        <td>${data.status}</td>
        <td>${data.pass}</td>
        <td>
            <img src="../image/edit.svg" onClick="editClient(${data.id})" alt="" width="25">
            <img src="../image/delete.svg" onClick="deleteClient(${data.id})" alt="" width="25">
        </td>
        `;
      return row;
    }

    function editClient(clientId) {
      let client = clients.find((client) => client.id == clientId);
      Swal.fire({
        html: `
                <div id="title">Faça a alteração no campo desejado</div>
                <div id="client">
                    <div>
                        <span>Nome: </span>
                        <input type="text" id="clientName" value="${client.nm_member}"/>
                    </div>
                    <div>
                        <span>Aniversário: </span>
                        <input type="date" id="clientBirth" value="${client.birthday_year}-${client.birthday_month}-${client.birthday_day}"/>
                    </div>
                    <div>
                        <span>Idade: </span>
                        <input type="text" id="clientAge" value="${client.birthday_age}"/>
                    </div>
                    <div>
                        <span>Gênero: </span>
                        <select type="text" id="clientGender">
                        <option value="Male">Male</option>/>
                        <option value="Female">Female</option>/>
                        <option value="${client.genero}" selected>${client.genero}</option>
                        </select>
                    </div>
                    <div>
                        <span>Endereço: </span>
                        <input type="text" id="clientAddress" value="${client.adress_input}"/>
                    </div>
                    <div>
                        <span>Telefone: </span>
                        <input type="text" id="clientTel" maxlength="11" value="(${client.phone01}) ${client.phone02}-${client.phone03}"/>
                    </div>
                    <div>
                        <span>E-mail: </span>
                        <input type="text" id="clientEmail" value="${client.email}"/>
                    </div>
                    <div>
                        <span>Lingua: </span>
                        <select type="text" id="clientlanguage">
                        <option value="japanese">japanese</option>/>
                        <option value="portugues">portugues</option>/>
                        <option value="english">english</option>/>
                        <option value="${client.lang01}" selected>${client.lang01}</option>
                        </select>
                    </div>
                    <div>
                        <span>Plano: </span>
                        <select type="text" id="clientplan">
                        <option value="A">A</option>/>
                        <option value="B">B</option>/>
                        <option value="C">C</option>/>
                        <option value="D">D</option>/>
                        <option value="E">E</option>/>
                        <option value="F">F</option>/>
                        <option value="${client.plans}" selected>${client.plans}</option>
                        </select>
                    </div>
                    <div>
                        <span>Graduação: </span>
                        <input type="text" id="clientGraduation" value="${client.graduation}"/>
                    </div>
                    <div>
                        <span>Status: </span>
                        <select type="text" id="clientStatus">
                        <option value="active">active</option>/>
                        <option value="inactive">inactive</option>/>
                        <option value="${client.status}" selected>${client.status}</option>
                        </select>
                    </div>
                    <div>
                        <span>Pass: </span>
                        <input maxlength="4"  id="clientPass" value="${client.pass}"/>

                    </div>
                </div>

                <style>
                #title{
                  font-size:4vh;
                }
                    #client{
                        width: 100%;
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: flex-start;
                        background-color: #EEEEEE;
                        padding-top: 3%;
                    }

                    #client div{
                        width: 30%;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding-left: 15%;
                        padding-bottom: 2%;

                    }

                    #client div input{
                        border-radius: 10px;
                        height: 5vh;
                        border: 1px solid gray;
                        text-indent: 10px;

                    }
                    #client div select{
                      border-radius: 10px;
                      width: 24vh;
                      height: 5vh;
                      border: 1px solid gray;
                      text-indent: 10px

                    }
                    #clientBirth{
                      border-radius: 10px;
                      width: 24vh;
                      height: 5vh;
                      border: 1px solid gray;
                      text-indent: 10px
                    }

                </style>
            `,
        showCancelButton: true,
        confirmButtonText: "Salvar",
        cancelButtonText: "Cancelar",
        width: 700,
      }).then((result) => {
       if (result.isConfirmed) {
          let obj = {
            id: clientId,
            nm_member: document.getElementById("clientName").value,
            birth: document.getElementById("clientBirth").value,
            age: document.getElementById("clientAge").value,
            gender: document.getElementById("clientGender").value,
            address: document.getElementById("clientAddress").value,
            tel: document.getElementById("clientTel").value,
            email: document.getElementById("clientEmail").value,
            language: document.getElementById("clientlanguage").value,
            plan: document.getElementById("clientplan").value,
            graduation: document.getElementById("clientGraduation").value,
            status: document.getElementById("clientStatus").value,
            pass: document.getElementById("clientPass").value,
          };

          console.log(obj);

          const attr = {
            method: "POST",
            body: JSON.stringify(obj),
            headers: { "Content-type": "application/json; charset=UTF-8" },
          };

          fetch("https://squid-app-ug7x6.ondigitalocean.app/listUpdate", attr)
            .then((x) => x.json())
            .then((response) => {
              console.log(response);
            });

          //console.log(obj.tel);
          /* 
          clients = clients.map((clientAux) => {
            if (clientAux.id == client.id) {
              client.client = name;
              client.birth = birth;
              client.age = age;
              client.gender = gender;
              client.address = address;
              client.tel = tel;
              client.email = email;
              client.language = language;
              client.plan = plan;
              client.graduation = graduation;
              client.status = status;
              client.Pass = status;
              return client;
            } else {
              return clientAux;
            }
          }); */
          restartTable();
        }
      });

      //mascara para o campo de telefone
      let campoTel = document.getElementById("clientTel");
      campoTel.addEventListener("blur", () => {
        var value = campoTel.value;
        var a = value.replace(/\D/g, ""); //Remove tudo o que não é dígito
        var b = a.replace(/^(\d{2})(\d)/g, "($1$2)"); //Coloca parênteses em volta dos dois primeiros dígitos
        var c = b.replace(/(\d)(\d{4})$/, "$1-$2"); //Coloca hífen entre o quarto e o quinto dígitos

        campoTel.value = c;
      });
    }

    function deleteClient(clientId) {
      clients = clients.filter((client) => client.id != clientId);

      const attr = {
        method: "POST",
        body: JSON.stringify({ id: clientId }),
        headers: { "Content-type": "application/json; charset=UTF-8" },
      };

      fetch("https://squid-app-ug7x6.ondigitalocean.app/listDelete", attr)
        .then((x) => x.json())
        .then((response) => {
          console.log(response);
        });

      restartTable();
    }

   async function restartTable() {
      var removeTbody = document.querySelector("tbody");
      while (removeTbody.hasChildNodes()) {
        removeTbody.removeChild(removeTbody.firstChild);
      }

     setTimeout(() => {
        fetch("https://squid-app-ug7x6.ondigitalocean.app/list", {
          method: "POST",
          body: JSON.stringify({ opt1: "", opt2: "" }),
          headers: { "Content-type": "application/json; charset=UTF-8" },
        })
          .then((x) => x.json())
          .then((res) => {
            clients = res;
            clientsHandler();
          });
      }, 3000);
    };
  </script>
</html>
