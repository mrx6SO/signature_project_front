<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graduation</title>
    <link rel="stylesheet" href="/signature-project-front/style/header.css">
    <link rel="stylesheet" href="/signature-project-front/style/dash.css">
</head>

<body>
  <div id="titlediv">
          <div id="titlemain" >Gym Control System</div>
          <div id="gym-name" >Kussano gym</div>
  </div>

    <div id="dash">
        <div id="header">

        </div>
        <div id="table">
            <table cellspacing="0" cellpadding="0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Faixa atual</th>
                        <th>Data da graduação</th>
                        <th>1º grau</th>
                        <th>2º grau</th>
                        <th>3º grau</th>
                        <th>4º grau</th>
                        <th>Aula pós-graduação</th>
                        <th>Observação</th>
                        <th>status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</body>
<script src="../script/swal.min.js"></script>
<script>
   const tbody = document.getElementsByTagName('tbody')[0]
    const gymName = document.getElementById("gym-name");
    const sessionGymName = sessionStorage.getItem("gym");

    if (sessionGymName) {
      gymName.innerHTML = sessionGymName;
    } else {
      gymName.innerHTML = "GYM error";
    }

    let clients1;
    const filter1 = ""//document.getElementById("filter1").value;
    const filter2 = ""//document.getElementById("filter2").value;
    const obj = { opt1: filter1, opt2: filter2 };

    fetch("https://squid-app-ug7x6.ondigitalocean.app/graduationlist", {
      method: "POST",
      body: JSON.stringify({ opt1: "", opt2: "" }),
      headers: { "Content-type": "application/json; charset=UTF-8" },
    })
      .then((x) => x.json())
      .then((res) => {
        clients1 = res;
        console.log(clients1);
        clientsHandler();
      });

    function clientsHandler() {
        for (let index = 0; index < clients1.length; index++) {
          const row = createNewTableRow(clients1[index]);
          tbody.innerHTML += row;

        }
      }

      function createNewTableRow(data) {
        //  console.log(data.nm_member_id)
          console.log(data.color)
        if(data.color=="0"){
          color = "white"
        }else if(data.color=="1"){
          color = "blue"
        }else if(data.color=="2"){
          color = "purpl"
        }else if(data.color=="3"){
          color = "brown"
        }else{
          color = "black"
        }

        let row = `
          <td class="email-tag">${data.nm_member}</td>
          <td><img src="../image/${color}.png" alt="" width="50"></td>
          <td>${data.graduation_dt}</td>
          <td>${data.first_point}</td>
          <td class="email-tag">${data.second_point}</td>
          <td class="email-tag">${data.third_point}</td>
          <td class="email-tag">${data.fourth_point}</td>
          <td>${data.lesson_after}</td>
          <td>${data.obs}</td>
          <td>${data.status}</td>
          <td>
              <img src="../image/edit.svg" onClick="editClient(${data.nm_member_id})" alt="" width="25">
          </td>
          `;
        return row;
      }

  //  let clients = [
      // {
        //    id: 1,
        //    client: "Helder",
        //    currentRange: 'blue',
      //   graduateDate: '2022-01-05',
         //   firstDegree: '2022-01-05',
           // secondDegree: "",
            //thirdDegree: "",
            //fourthDegree: "",
            //postGraduationClass: "10",
            //observations: "faltou 3",
            //status: "active"
        //},
        //{
          //  id: 2,
            //client: "karla",
            //currentRange: 'red',
            //graduateDate: '2021-12-27',
            //firstDegree: '2022-05-18',
            //secondDegree: "2022-07-15",
            //thirdDegree: "2022-08-10",
            //fourthDegree: "",
            //postGraduationClass: "39",
            //observations: "mês que vem graduação",
            //status: "active"
        //}
    //]



        function editClient(clientId) {
        let client = clients1.find(client => client.nm_member_id == clientId)
        let graduatedate = client.graduation_dt.replace("/","-")
           if(client.color=="0"){
          color = "white"
        }else if(client.color=="1"){
          color = "blue"
        }else if(client.color=="2"){
          color = "purpl"
        }else if(client.color=="3"){
          color = "brown"
        }else{
          color = "black"
        }
        console.log(client)
        Swal.fire({
            html: `
                <div id="client">
                   <div class="main-div" id="left-div-edit">
                    <div>
                        <span>Nome: </span>
                        <input type="text" id="clientName" disabled="disabled" value="${client.nm_member}"/>
                    </div>
                    <div>
                        <span>Faixa atual: </span>
                        <select id="currentRange">
                            <option value="${client.color}" selected>${color}</option>
                            <option value="0">white</option>
                            <option value="1">blue</option>
                            <option value="2">purpl</option>
                            <option value="3">brown</option>
                            <option value="4">black</option>
                        </select>
                    </div>
                    <div>
                        <span>Data da graduação: </span>
                        <input type="date" id="graduateDate" value="${client.graduation_dt}"/>
                    </div>
                    <div>
                        <span>1º Grau: </span>
                        <input type="date" id="firstDegree" value="${client.first_point}"/>
                    </div>
                    <div>
                        <span>2º Grau: </span>
                        <input type="date" id="secondDegree" value="${client.second_point}"/>
                    </div>
                  </div>
                  <div class="main-div"  id ="right-div">
                    <div>
                        <span>3º Grau: </span>
                        <input type="date" id="thirdDegree" value="${client.third_point}"/>
                    </div>
                    <div>
                        <span>4º Grau: </span>
                        <input type="date" id="fourthDegree" value="${client.fourth_point}"/>
                    </div>
                    <div>
                        <span>Aula pós-graduação: </span>
                        <input type="number" id="postGraduationClass" value="${client.lesson_after}"/>
                    </div>
                    <div>
                        <span>Observações: </span>
                        <textarea type="text" id="observations" value="${client.obs}"/></textarea>
                    </div>
                    <div>
                        <span>Status: </span>
                        <input type="text" id="status" value="${client.status}" disabled="disabled"/>
                    </div>
                  </div>
                </div>

                <style>

                    #client{
                        width: 100%;
                        height: 100%;
                        height: 300px;
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: flex-start;
                    }
                    .main-div{
                      width:50%;
                      height;100%;
                      display:block;
                    }
                    .main-div div{
                      height:15%;
                      display:flex;
                      justify-content: flex-end;
                      margin-top:15px;
                    }
                    .main-div input, select ,textarea{
                      width:50%;
                      height:90%;
                      border-radius:10px;
                    }
                </style>
            `,
            showCancelButton: true,
            confirmButtonText: "Salvar",
            cancelButtonText: "Cancelar",
        }).then(result => {
            if (result.isConfirmed) {
                const name = document.getElementById("clientName").value
                var currentRange = document.getElementById("currentRange").value
                var graduateDate = document.getElementById("graduateDate").value
                var firstDegree = document.getElementById("firstDegree").value
                var secondDegree = document.getElementById("secondDegree").value
                var thirdDegree = document.getElementById("thirdDegree").value
                var fourthDegree = document.getElementById("fourthDegree").value
                var postGraduationClass = document.getElementById("postGraduationClass").value
                var observations = document.getElementById("observations").value
                var status = document.getElementById("status").value
                console.log(currentRange)
                if(client.first_point=="-"){
                    firstpoint=""
                }else{
                    firstpoint=client.first_point
                }
                 if(client.second_point=="-"){
                    secondpoint=""
                }else{
                    secondpoint=client.second_point
                }
                 if(client.third_point=="-"){
                    thirdpoint=""
                }else{
                    thirdpoint=client.third_point
                }
                 if(client.fourth_point=="-"){
                    fourthpoint=""
                }else{
                    fourthpoint=client.fourth_point
                }
              update_id = client.nm_member_id
              var graduateDateupdate=graduateDate
              var change = "0"
              if(currentRange==0){
                color="white"
              }else if(currentRange==1){
              color="blue"
            }else if(currentRange==2){
              color="purpl"
            }else if(currentRange==3){
              color="brown"
            }else if(currentRange==4){
              color="black"
              }

                if(client.color!=currentRange){ //カラーの変更をした時の処理
                  kubun = `graduar para faixa ${color}`
                  graduateDateupdate = getCurrentYYYYMMDD()
                  firstDegree="-"
                  secondDegree="-"
                  thirdDegree="-"
                  fourthDegree="-"
                  console.log(graduateDateupdate)
                  change = "1"
                }else if(firstpoint!=firstDegree){
                  kubun = `1º grau da faixa ${color}`
                  change = "1"
                }else if(secondpoint!=secondDegree){
                  kubun = `2º grau da faixa ${color}`
                  change = "1"
                }else if(thirdpoint!=thirdDegree){
                  kubun = `3º grau da faixa ${color}`
                  change = "1"
                }else if(fourthpoint!=fourthDegree){
                  kubun = `4º grau da faixa ${color}`
                  change = "1"
                }else if(client.lesson_after!=postGraduationClass){
                  kubun = `Alterar quantidades de aulas para ${postGraduationClass}`
                  change = "1"
                }

                if (change==1){
                if(firstDegree==""){
                  firstDegree="-"
                }
                if(secondDegree==""){
                  secondDegree="-"
                }
                if(thirdDegree==""){
                  thirdDegree="-"
                }
                if(fourthDegree==""){
                  fourthDegree="-"
                }
                if(observations==""){
                  observations="-"
                }

                let obj = {
                  id: client.nm_member_id,
                  color: currentRange,
                  status: status,
                  graduation_dt: graduateDateupdate,
                  first_point: firstDegree,
                  second_point: secondDegree,
                  third_point: thirdDegree,
                  fourth_point: fourthDegree,
                  lesson_after: postGraduationClass,
                  obs: observations,
                };
                swall_confirm(name,kubun,obj)
                console.log(obj)
              }else{

              }

            }
        })
    }

    function getCurrentYYYYMMDD() {

    var date = new Date();
    var y = date.getFullYear();
    var m = ("00" + (date.getMonth() + 1)).slice(-2);
    var d = ("00" + date.getDate()).slice(-2);
    return [y, m, d].join("-");
  }

function swall_confirm(name,kubun,obj){
  console.log(name)
  console.log(kubun)

Swal.fire({
    html: `
   <div id="title">
    <span>Graduação do aluno ${name}
   </div>
   <div id="contentes-div">
      <div id="contentes-center">
      <span>${kubun}</span>
      </div>
    </div>
    <style>
      #title{
        width:100%;
        height:80px;
        margin-button:250px;
        font-size:3vw;
        display:flex;
        justify-content: center;
      }
      #contentes-div{
        border:10px solid #EEEEEE;
        border-radius:10px;
        height:100px;
        font-size:3vw;

      }
      #contentes-center{
        display:flex;
        justify-content: center;
        margin-top : 15px;
      }
    </style>`,
    showCancelButton: true,
    confirmButtonText: "Salvar",
    cancelButtonText: "Cancelar",
}).then(result => {
 if (result.isConfirmed) {
   console.log(obj)
    const attr = {
      method: "POST",
      body: JSON.stringify(obj),
      headers: { "Content-type": "application/json; charset=UTF-8" },
    };

    fetch("https://squid-app-ug7x6.ondigitalocean.app/graduationUpdate", attr)
      .then((x) => x.json())
      .then((response) => {
        console.log(response);
      });
    restartTable();
  }
});
}

    function deleteClient(clientId) {
        clients = clients.filter(client => client.id != clientId)
        restartTable()
    }

    async function restartTable() {
       var removeTbody = document.querySelector("tbody");
       while (removeTbody.hasChildNodes()) {
         removeTbody.removeChild(removeTbody.firstChild);
       }

      setTimeout(() => {
         fetch("https://squid-app-ug7x6.ondigitalocean.app/graduationlist", {
           method: "POST",
           body: JSON.stringify({ opt1: "", opt2: "" }),
           headers: { "Content-type": "application/json; charset=UTF-8" },
         })
           .then((x) => x.json())
           .then((res) => {
             clients1 = res;
             //console.log(clients)
             clientsHandler();
           });
       }, 3000);
     };

    clientsHandler()



</script>
